<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ì€í•˜ìˆ˜ ê´€ì¸¡ í™•ë¥  ê³„ì‚°ê¸° Pro Max (Global Edition)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body { margin: 0; padding: 0; overflow: hidden; background: #000; }
    #map { width: 100vw; height: 100vh; }

    #ui-panel{
      position:absolute; top:20px; right:20px; z-index:1000;
      background:rgba(30,30,30,0.85); backdrop-filter:blur(10px); color:white;
      padding:20px; border-radius:12px; font-family:sans-serif;
      box-shadow:0 4px 15px rgba(0,0,0,0.5); width:270px; max-height:90vh; overflow-y:auto;
      box-sizing:border-box;
    }
    #ui-panel::-webkit-scrollbar{ width:8px; }
    #ui-panel::-webkit-scrollbar-thumb{ background:rgba(255,255,255,0.3); border-radius:4px; }

    .mobile-handle{
      display:none; width:40px; height:5px; background:rgba(255,255,255,0.4);
      border-radius:3px; margin:0 auto 15px auto; cursor:pointer;
    }

    .ui-section{ margin-bottom:15px; }
    .ui-section:last-child{ margin-bottom:0; }
    .ui-title{ font-size:14px; font-weight:bold; margin-bottom:8px; color:#aaa; }

    select, input[type="date"], input[type="text"], button{
      width:100%; padding:8px; margin-top:5px; background:rgba(255,255,255,0.1);
      color:white; border:1px solid #555; border-radius:6px; cursor:pointer; box-sizing:border-box;
    }
    input[type="text"] { cursor: text; }
    input[type="text"]::placeholder { color: #888; }
    select option{ background:#333; }
    button:hover{ background:rgba(255,255,255,0.2); }

    .flex-row{ display:flex; gap:8px; }
    .flex-row input, .flex-row select { flex:2; margin-top:0; }
    .flex-row button{ flex:1; margin-top:0; }
    label{ cursor:pointer; display:flex; align-items:center; gap:8px; font-size:14px; }
    input[type="range"]{ width:100%; margin-top:5px; cursor:pointer; }

    .time-display-box{ text-align:center; font-size:18px; font-weight:bold; color:#0df; margin-bottom:5px; }

    .leaflet-popup-content-wrapper, .leaflet-popup-tip{
      background:rgba(20,20,20,0.95) !important; backdrop-filter:blur(10px) !important;
      -webkit-backdrop-filter:blur(10px) !important; color:#ffffff !important; box-shadow:0 4px 15px rgba(0,0,0,0.8) !important;
      width:320px;
    }
    .leaflet-popup-content hr{ border:0; border-top:1px solid rgba(255,255,255,0.15); margin:10px 0; }

    .opacity-control{ display:flex; align-items:center; gap:10px; margin-top:5px; font-size:12px; }
    .opacity-label{ min-width:75px; }

    .best-date-box{
      background:rgba(0,255,255,0.1); border:1px solid rgba(0,255,255,0.3);
      padding:10px; border-radius:6px; text-align:center; cursor:pointer; transition:0.2s;
    }
    .best-date-box:hover{ background:rgba(0,255,255,0.2); }

    .notice-text{ font-size:11px; color:#999; margin-top:8px; line-height:1.4; word-break:keep-all; }

    .btn-simulate{
      background:rgba(0,255,100,0.2); border:1px solid #0f0; color:#0f0; font-weight:bold;
      padding:12px; margin-top:10px; transition:0.3s;
    }
    .btn-simulate:hover:not(:disabled){ background:rgba(0,255,100,0.4); color:white; }
    .btn-simulate:disabled{ background:rgba(100,100,100,0.2); border-color:#555; color:#888; cursor:not-allowed; }

    .btn-capture{
      background:rgba(0,221,255,0.15); border:1px dashed #0df; color:#0df;
      font-weight:bold; padding:10px; margin-top:12px; transition:0.3s; border-radius:6px; width: 100%; box-sizing: border-box;
    }
    .btn-capture:hover{ background:rgba(0,221,255,0.35); color:#fff; }
    
    .btn-favorite {
      background:rgba(255,200,0,0.15); border:1px dashed #fd0; color:#fd0;
      font-weight:bold; padding:10px; margin-top:6px; transition:0.3s; border-radius:6px; width: 100%; box-sizing: border-box;
    }
    .btn-favorite:hover { background:rgba(255,200,0,0.35); color:#fff; }

    #progress-container{ width:100%; height:6px; background:#333; border-radius:3px; margin-top:10px; overflow:hidden; display:none; }
    #progress-bar{ width:0%; height:100%; background:#0df; transition:width 0.2s ease-out; }

    .leaflet-control-locate{
      background:#1e1e1e; border:2px solid rgba(255,255,255,0.2); color:white; cursor:pointer;
      border-radius:4px; text-align:center; line-height:30px; font-size:18px; width:34px; height:34px;
      box-shadow:0 1px 5px rgba(0,0,0,0.65); transition:background 0.2s;
    }
    .leaflet-control-locate:hover{ background:#333; }

    .gonogo-box{ padding:10px; border-radius:8px; margin-bottom:12px; text-align:left; font-size:13px; line-height:1.6; }
    .gonogo-title{ font-size:18px; font-weight:900; text-align:center; margin-bottom:8px; letter-spacing:1px; }
    .gonogo-item{ display:flex; justify-content:space-between; margin-bottom:4px; border-bottom:1px dashed rgba(255,255,255,0.1); padding-bottom:4px; }
    .gonogo-item:last-child{ border-bottom:none; padding-bottom:0; }
    .mw-window-box{ background:rgba(0,0,0,0.5); border:1px solid #444; padding:12px; border-radius:8px; margin-bottom:12px; }
    .timeline-legend{ display:flex; gap:6px; font-size:10px; justify-content:center; margin-top:6px; flex-wrap:wrap; }
    .legend-item{ display:flex; align-items:center; gap:4px; color:#ddd; }
    .legend-box{ width:10px; height:10px; border-radius:2px; }
    .cloud-detail{ font-size:11px; color:#aaa; font-weight:normal; }
    .warning-text{ color:#ff5555; font-weight:bold; font-size:12px; }
    .safe-text{ color:#55ff55; font-size:12px; }
    .mode-badge{ display:inline-block; padding:4px 8px; border-radius:999px; font-size:11px; margin-top:6px; border:1px solid rgba(255,255,255,0.15); }
    .mode-weather{ background:rgba(0,255,100,0.15); color:#9f9; }
    .mode-no-weather{ background:rgba(255,200,0,0.15); color:#fd0; }

    @media (max-width:768px){
      .mobile-handle{ display:block; }
      #ui-panel{
        top:auto; bottom:0; right:0; left:0; width:100vw;
        border-radius:20px 20px 0 0; max-height:65vh;
        transform:translateY(0); transition:transform 0.3s cubic-bezier(0.4,0,0.2,1);
        padding-bottom:30px;
      }
      #ui-panel.collapsed{ transform:translateY(calc(100% - 50px)); }
      .leaflet-control-locate{ margin-left:10px !important; margin-top:10px !important; }
      .leaflet-popup-content-wrapper, .leaflet-popup-tip{ width:280px; }
    }
  </style>
</head>

<body>
  <div id="ui-panel">
    <div class="mobile-handle" id="mobile-toggle"></div>

    <div class="ui-section">
      <div class="ui-title">ğŸŒ ì„¸ê³„ ì¥ì†Œ ê²€ìƒ‰</div>
      <div class="flex-row">
        <input type="text" id="search-input" placeholder="ë„ì‹œ, ì§€ì—­, ëª…ì†Œ ì…ë ¥..." autocomplete="off">
        <button id="btn-search">ê²€ìƒ‰</button>
      </div>
      <div class="notice-text" id="search-hint" style="display:none;"></div>
    </div>

    <div class="ui-section">
      <div class="ui-title">â­ ë‚´ ì¥ì†Œ (ì¦ê²¨ì°¾ê¸°)</div>
      <div class="flex-row">
        <select id="favorite-spots">
          <option value="">ì €ì¥ëœ ì¥ì†Œ ì„ íƒ...</option>
        </select>
        <button id="btn-del-fav" style="flex:0.5; background:rgba(255,50,50,0.2); border-color:#f55; color:#f55;">ì‚­ì œ</button>
      </div>
    </div>

    <div class="ui-section">
      <div class="ui-title">ğŸ—ºï¸ ì§€ë„ í…Œë§ˆ</div>
      <select id="map-theme">
        <option value="dark">ë‹¤í¬ ëª¨ë“œ (ê´€ì¸¡ ìµœì í™”)</option>
        <option value="satellite">ìœ„ì„± ì§€ë„ (ì§€í˜• í™•ì¸ìš©)</option>
        <option value="standard">ì¼ë°˜ ì§€ë„</option>
      </select>
    </div>

    <div class="ui-section">
      <div class="ui-title">âœ¨ ê´‘í•´ ì§€ë„</div>
      <label><input type="checkbox" id="light-pollution-toggle" checked> ì˜¤ë²„ë ˆì´ ì¼œê¸°</label>
      <div class="opacity-control">
        <span class="opacity-label">íˆ¬ëª…ë„ (<span id="opacity-val">60</span>%)</span>
        <input type="range" id="lp-opacity" min="0" max="1" step="0.1" value="0.6">
      </div>
    </div>

    <div class="ui-section">
      <div class="ui-title">ğŸ“… ê´€ì¸¡ ì˜ˆì •ì¼</div>
      <div class="flex-row">
        <input type="date" id="obs-date">
        <button id="btn-today">ì˜¤ëŠ˜</button>
      </div>
      <div class="notice-text">
        â€» ê¸°ìƒ ì˜ˆë³´(Open-Meteo)ëŠ” ìµœëŒ€ 14ì¼ê¹Œì§€ë§Œ ì œê³µë©ë‹ˆë‹¤. ì´í›„ ë‚ ì§œëŠ” ë‹¬ë¹›/ì½”ì–´/ê´‘í•´ë§Œ í‘œì‹œë©ë‹ˆë‹¤.
      </div>
      <div id="mode-badge" class="mode-badge mode-weather">MODE: Weather ON</div>
    </div>

    <div class="ui-section">
      <div class="ui-title">â° ê´€ì¸¡ ì‹œê°„</div>
      <div class="time-display-box" id="time-text">22:00</div>
      <input type="range" id="obs-time" min="0" max="23" value="22">
    </div>

    <div class="ui-section" id="best-date-section">
      <div class="ui-title">ğŸ”­ ë‹¤ìŒ ê´€ì¸¡ ìµœì ê¸° ì¶”ì²œ</div>
      <div class="best-date-box" id="best-date-box">ê³„ì‚° ì¤‘...</div>
      <button id="btn-simulate" class="btn-simulate">ğŸš€ ì„ íƒí•œ ë‚ ì§œì˜ ìµœì ì§€ ì°¾ê¸°</button>
      <div id="progress-container"><div id="progress-bar"></div></div>
      <div id="simulate-msg" class="notice-text" style="display:none; color:#0df;"></div>
    </div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>

  <script>
    // ===== Date helpers =====
    function pad2(n){ return String(n).padStart(2,'0'); }
    function fmtYMD(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
    function getToday(){ return new Date(); }
    function daysBetween(a, b){
      const aa = new Date(a.getFullYear(), a.getMonth(), a.getDate());
      const bb = new Date(b.getFullYear(), b.getMonth(), b.getDate());
      return Math.round((bb - aa) / 86400000);
    }

    function getMoonPhaseEmoji(phase) {
      if (phase < 0.06) return "ğŸŒ‘";
      if (phase < 0.19) return "ğŸŒ’";
      if (phase < 0.31) return "ğŸŒ“";
      if (phase < 0.44) return "ğŸŒ”";
      if (phase < 0.56) return "ğŸŒ•";
      if (phase < 0.69) return "ğŸŒ–";
      if (phase < 0.81) return "ğŸŒ—";
      if (phase < 0.94) return "ğŸŒ˜";
      return "ğŸŒ‘";
    }

    document.getElementById('obs-date').value = fmtYMD(getToday());

    // ===== Map init =====
    const map = L.map('map', { zoomControl: false }).setView([38.09, 127.07], 10);
    L.control.zoom({ position: 'topleft' }).addTo(map);

    const LocateControl = L.Control.extend({
      options: { position: 'topleft' },
      onAdd: function(map) {
        const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-locate');
        container.innerHTML = 'ğŸ“';
        container.title = 'ë‚´ ìœ„ì¹˜ë¡œ ì´ë™';

        L.DomEvent.disableClickPropagation(container);
        L.DomEvent.on(container, 'click', (e) => {
          L.DomEvent.stop(e);
          if (navigator.geolocation) {
            container.innerHTML = 'âŒ›';
            navigator.geolocation.getCurrentPosition(
              pos => {
                container.innerHTML = 'ğŸ“';
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                map.setView([lat, lng], 11);
                analyzeData(lat, lng, "ë‚´ ìœ„ì¹˜ (í˜„ìœ„ì¹˜)");

                if(window.innerWidth <= 768) {
                  document.getElementById('ui-panel').classList.add('collapsed');
                }
              },
              err => {
                container.innerHTML = 'ğŸ“';
                alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì €ì˜ ìœ„ì¹˜ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
              }
            );
          } else {
            alert('ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìœ„ì¹˜ ì •ë³´ê°€ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          }
        });
        return container;
      }
    });
    map.addControl(new LocateControl());

    const standardLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' });
    const darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19, attribution: '&copy; CARTO' });
    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, attribution: '&copy; Esri' });

    let currentBaseLayer = darkLayer;
    currentBaseLayer.addTo(map);

    const lightPollutionLayer = L.tileLayer(
      'https://tiles.arcgis.com/tiles/b3fMqPOmotX6SV4k/arcgis/rest/services/ArtificialSkyBrightness/MapServer/tile/{z}/{y}/{x}',
      { opacity: 0.6, maxNativeZoom: 6, maxZoom: 19, zIndex: 10 }
    ).addTo(map);

    document.getElementById('mobile-toggle').addEventListener('click', function() {
      document.getElementById('ui-panel').classList.toggle('collapsed');
    });

    // ===== ì‹ ê·œ: ì¦ê²¨ì°¾ê¸°(Local Storage) ë¡œì§ =====
    function loadFavorites() {
      const sel = document.getElementById('favorite-spots');
      sel.innerHTML = '<option value="">ì €ì¥ëœ ì¥ì†Œ ì„ íƒ...</option>';
      let favs = JSON.parse(localStorage.getItem('mw_fav_spots') || '[]');
      favs.forEach((f, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = f.name;
        sel.appendChild(opt);
      });
    }

    window.saveFavorite = function(ev, lat, lng, defaultName) {
      if (ev) { ev.preventDefault(); ev.stopPropagation(); }
      let favs = JSON.parse(localStorage.getItem('mw_fav_spots') || '[]');
      let name = prompt("ì €ì¥í•  ì¥ì†Œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", defaultName || 'ìƒˆë¡œìš´ ê´€ì¸¡ì§€');
      if (!name) return; // ì‚¬ìš©ìê°€ ì·¨ì†Œí•œ ê²½ìš°

      favs.push({ name: name, lat: lat, lng: lng });
      localStorage.setItem('mw_fav_spots', JSON.stringify(favs));
      loadFavorites();
      alert(`'${name}'ì´(ê°€) ì¦ê²¨ì°¾ê¸°ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    };

    document.getElementById('favorite-spots').addEventListener('change', function(e) {
      const val = e.target.value;
      if (val === "") return;
      let favs = JSON.parse(localStorage.getItem('mw_fav_spots') || '[]');
      const spot = favs[val];
      if (spot) {
        map.setView([spot.lat, spot.lng], 11);
        analyzeData(spot.lat, spot.lng, spot.name);
        if(window.innerWidth <= 768) {
          document.getElementById('ui-panel').classList.add('collapsed');
        }
      }
    });

    document.getElementById('btn-del-fav').addEventListener('click', function() {
      const sel = document.getElementById('favorite-spots');
      const val = sel.value;
      if (val === "") {
        alert("ëª©ë¡ì—ì„œ ì‚­ì œí•  ì¥ì†Œë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
      }
      let favs = JSON.parse(localStorage.getItem('mw_fav_spots') || '[]');
      const name = favs[val].name;
      if(confirm(`'${name}'ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        favs.splice(val, 1);
        localStorage.setItem('mw_fav_spots', JSON.stringify(favs));
        loadFavorites();
        map.closePopup();
      }
    });

    // ì´ˆê¸° ì¦ê²¨ì°¾ê¸° ë¡œë“œ
    loadFavorites();

    // ===== Search Feature (Nominatim Geocoding) =====
    let searchAbort = null;
    let lastSearchTs = 0;

    function showSearchHint(text, color="#999"){
      const el = document.getElementById('search-hint');
      el.style.display = 'block';
      el.style.color = color;
      el.textContent = text;
    }
    function hideSearchHint(){
      const el = document.getElementById('search-hint');
      el.style.display = 'none';
      el.textContent = '';
    }

    async function performSearch() {
      const query = document.getElementById('search-input').value.trim();
      if (!query) return;

      const now = Date.now();
      if (now - lastSearchTs < 350) return;
      lastSearchTs = now;

      const btn = document.getElementById('btn-search');
      const originalText = btn.innerText;
      btn.innerText = "â³...";
      btn.disabled = true;
      showSearchHint("ê²€ìƒ‰ ì¤‘...", "#0df");

      if (searchAbort) searchAbort.abort();
      searchAbort = new AbortController();

      try {
        const url = `https://nominatim.openstreetmap.org/search?format=json&limit=5&accept-language=ko&q=${encodeURIComponent(query)}`;
        const response = await fetch(url, {
          signal: searchAbort.signal,
          headers: { "Accept": "application/json" }
        });

        if (!response.ok) {
          if (response.status === 429) {
            showSearchHint("ìš”ì²­ì´ ë„ˆë¬´ ë§ì•„ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ê²€ìƒ‰í•´ì£¼ì„¸ìš”.", "#fd0");
          } else {
            showSearchHint(`ê²€ìƒ‰ ì‹¤íŒ¨(${response.status}). ë„¤íŠ¸ì›Œí¬ ì´ìŠˆì¼ ìˆ˜ ìˆì–´ìš”.`, "#f55");
          }
          return;
        }

        const data = await response.json();

        if (data && data.length > 0) {
          let pick = 0;
          if (data.length > 1) {
            const menu = data.map((d, i) => `${i+1}) ${d.display_name}`).join("\n");
            const ans = prompt(`ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ëŸ¬ ê°œì…ë‹ˆë‹¤. ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”:\n\n${menu}\n\n(ì·¨ì†Œí•˜ë©´ 1ë²ˆ ìë™ ì„ íƒ)`, "1");
            const n = parseInt(ans, 10);
            if (!isNaN(n) && n >= 1 && n <= data.length) pick = n - 1;
          }

          const lat = parseFloat(data[pick].lat);
          const lng = parseFloat(data[pick].lon);
          const displayName = (data[pick].display_name || "").split(',')[0] || query;

          map.setView([lat, lng], 11);
          analyzeData(lat, lng, displayName);

          hideSearchHint();

          if(window.innerWidth <= 768) {
            document.getElementById('ui-panel').classList.add('collapsed');
          }
        } else {
          showSearchHint("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ í‚¤ì›Œë“œë¥¼ ì¨ë³´ì„¸ìš”.", "#fd0");
        }
      } catch (error) {
        if (error && error.name === "AbortError") return;
        console.error("Geocoding error:", error);
        showSearchHint("ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "#f55");
      } finally {
        btn.innerText = originalText;
        btn.disabled = false;
      }
    }

    document.getElementById('btn-search').addEventListener('click', performSearch);
    document.getElementById('search-input').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') performSearch();
    });

    // ===== Milky Way & Astro Logic =====
    function getGalacticCorePosition(date, lat, lng) {
      const RA = 266.4168, Dec = -29.0078, rad = Math.PI / 180;
      const jd = (date.getTime() / 86400000) + 2440587.5;
      const d = jd - 2451545.0;
      let LST = (280.46061837 + 360.98564736629 * d + lng) % 360;
      if (LST < 0) LST += 360;
      let HA = LST - RA;
      if (HA < 0) HA += 360;

      const HA_rad = HA * rad, Dec_rad = Dec * rad, Lat_rad = lat * rad;
      const sinAlt = Math.sin(Dec_rad) * Math.sin(Lat_rad) + Math.cos(Dec_rad) * Math.cos(Lat_rad) * Math.cos(HA_rad);
      const sinAltC = Math.max(-1, Math.min(1, sinAlt));
      const altRad = Math.asin(sinAltC);
      const alt = altRad / rad;
      const cosAlt = Math.cos(altRad);

      let cosAz = (Math.sin(Dec_rad) - Math.sin(Lat_rad) * sinAltC) / (Math.cos(Lat_rad) * (cosAlt || 1e-9));
      cosAz = Math.max(-1, Math.min(1, cosAz));
      let az = Math.acos(cosAz) / rad;
      if (Math.sin(HA_rad) > 0) az = 360 - az;
      return { altitude: alt, azimuth: az };
    }

    function evaluateMoonImpact(date, lat, lng, gcAzimuth) {
      const illum = SunCalc.getMoonIllumination(date);
      const moonIllum = Math.round(illum.fraction * 100);
      const moonEmoji = getMoonPhaseEmoji(illum.phase);

      const mPos = SunCalc.getMoonPosition(date, lat, lng);
      const mAlt = mPos.altitude * 180 / Math.PI;
      let mAz = (mPos.azimuth * 180 / Math.PI) + 180;

      let azDiff = Math.abs(mAz - gcAzimuth);
      if (azDiff > 180) azDiff = 360 - azDiff;

      let isSafe = false, statusColor = "", statusText = "", timelineColor = "";
      if (mAlt < 0) {
        isSafe = true; statusColor = "#0df"; statusText = `ğŸŸ¢ ì™„ë²½ ì°¨ë‹¨ (-${Math.abs(Math.round(mAlt))}Â°)`; timelineColor = "#fd0";
      } else if (moonIllum < 15) {
        isSafe = true; statusColor = "#0df"; statusText = `ğŸŸ¢ ì˜í–¥ ë¯¸ë¯¸ (${moonIllum}%)`; timelineColor = "#fd0";
      } else {
        if (azDiff < 40 && mAlt > 0) { statusColor = "#f55"; statusText = `ğŸ”´ ì½”ì–´ ë°©í•´ (ë‹¬ ê²¹ì¹¨!)`; timelineColor = "#f00"; }
        else if (mAlt > 10) { statusColor = "#f55"; statusText = `ğŸ”´ ë‹¬ë¹› ì”»ê¹€ (ê³ ë„ ${Math.round(mAlt)}Â°)`; timelineColor = "#635"; }
        else { statusColor = "#fa0"; statusText = `ğŸŸ¡ ì €ê³ ë„ ê°„ì„­ ì£¼ì˜`; timelineColor = "#c60"; }
      }
      return { isSafe, statusColor, statusText, timelineColor, moonIllum, mAlt, azDiff, moonEmoji };
    }

    function evaluateCloudImpact(cLow, cMid, cHigh, cTotal) {
      let isSafe = false, statusColor = "", statusText = "";
      if (cHigh >= 20) { isSafe = false; statusColor = "#f55"; statusText = `ğŸ”´ ìƒì¸µìš´ ì¹˜ëª…ì `; }
      else if (cTotal >= 35) { isSafe = false; statusColor = "#f55"; statusText = `ğŸ”´ êµ¬ë¦„ ë§ìŒ (ê´€ì¸¡ ë¶ˆê°€)`; }
      else if (cTotal > 15 || cHigh > 10) { isSafe = true; statusColor = "#fa0"; statusText = `ğŸŸ¡ ì•½ê°„ íë¦¼`; }
      else { isSafe = true; statusColor = "#0df"; statusText = `ğŸŸ¢ ì¾Œì²­`; }
      return { isSafe, statusColor, statusText };
    }

    function evaluateDirectionalLightPollution(lat, lng, coreAzimuth) {
      const seoulLat = 37.5665, seoulLng = 126.9780;
      const R = 6371, dLat = (seoulLat - lat) * Math.PI / 180, dLon = (seoulLng - lng) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat * Math.PI / 180) * Math.cos(seoulLat * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
      const distance = R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));

      const y = Math.sin(dLon) * Math.cos(seoulLat * Math.PI / 180);
      const x = Math.cos(lat * Math.PI / 180) * Math.sin(seoulLat * Math.PI / 180) - Math.sin(lat * Math.PI / 180) * Math.cos(seoulLat * Math.PI / 180) * Math.cos(dLon);
      let bearingToSeoul = Math.atan2(y, x) * 180 / Math.PI;
      bearingToSeoul = (bearingToSeoul + 360) % 360;

      let angleDiff = Math.abs(coreAzimuth - bearingToSeoul);
      if (angleDiff > 180) angleDiff = 360 - angleDiff;

      let isSafe = true, statusColor = "", statusText = "";
      if (distance < 15) { isSafe = false; statusColor = "#f55"; statusText = `ğŸ”´ ë„ì‹¬ ë‚´ë¶€ (ì „ë°©ìœ„ ê´‘í•´)`; }
      else if (distance < 65 && angleDiff < 35) { isSafe = false; statusColor = "#f55"; statusText = `ğŸ”´ ì½”ì–´ ë°©í–¥ ê±°ëŒ€ ê´‘í•´ (ë¹›ê·¸ë¬¼)`; }
      else if (distance < 90 && angleDiff < 45) { isSafe = true; statusColor = "#fa0"; statusText = `ğŸŸ¡ ì§€í‰ì„  ê´‘í•´ ê°„ì„­ ì£¼ì˜`; }
      else { isSafe = true; statusColor = "#0df"; statusText = `ğŸŸ¢ ì½”ì–´ ë°©í–¥ ì§€í‰ì„  ì–´ë‘ì›€`; }

      const bortleClass = distance < 15 ? 8 : (distance < 30 ? 6 : (distance < 50 ? 4 : (distance < 80 ? 3 : 2)));
      return { isSafe, statusColor, statusText, bortleClass, angleDiff, distance, bearingToSeoul };
    }

    function isWithinWeatherWindow(dateStr){
      const sel = new Date(dateStr);
      const diff = daysBetween(getToday(), sel);
      return diff >= 0 && diff <= 14;
    }

    function validateSpots(spots){
      const bad = spots.filter(s => typeof s.lat !== 'number' || typeof s.lng !== 'number');
      if (bad.length) {
        console.warn("Invalid candidateSpots:", bad);
        return false;
      }
      return true;
    }

    function findHourlyIndex(hourlyTimes, dateStr, hour){
      if (!Array.isArray(hourlyTimes)) return -1;
      const target = `${dateStr}T${pad2(hour)}:00`;
      return hourlyTimes.indexOf(target);
    }

    function updateWeatherModeUI(){
      const dateStr = document.getElementById('obs-date').value;
      const badge = document.getElementById('mode-badge');
      const btn = document.getElementById('btn-simulate');
      const within = isWithinWeatherWindow(dateStr);

      if(within){
        badge.textContent = "MODE: Weather ON";
        badge.classList.remove('mode-no-weather');
        badge.classList.add('mode-weather');
        btn.disabled = false;
        btn.textContent = "ğŸš€ ì„ íƒí•œ ë‚ ì§œì˜ ìµœì ì§€ ì°¾ê¸°";
      } else {
        badge.textContent = "MODE: Weather OFF (14ì¼ ì´í›„)";
        badge.classList.remove('mode-weather');
        badge.classList.add('mode-no-weather');
        btn.disabled = true;
        btn.textContent = "ğŸŒ™ 14ì¼ ì´í›„: ë‚ ì”¨ ì—†ì´ ë¶„ì„";
        const msg = document.getElementById('simulate-msg');
        msg.style.display = 'block';
        msg.style.color = '#fd0';
        msg.innerText = 'âš ï¸ ì„ íƒ ë‚ ì§œê°€ 14ì¼ ì´í›„ë¼ ì „êµ­ ìµœì ì§€ ì‹œë®¬ë ˆì´ì…˜ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.';
      }
    }

    let analyzeSeq = 0;
    let marker = null, coreLine = null, currentLat = null, currentLng = null;

    async function analyzeData(lat, lng, spotName=null){
      const mySeq = ++analyzeSeq;

      currentLat = lat; currentLng = lng;
      if (marker) map.removeLayer(marker);
      if (coreLine) map.removeLayer(coreLine);

      marker = L.marker([lat, lng]).addTo(map);
      marker.bindPopup("ë°ì´í„° ë¶„ì„ ì¤‘... ğŸ“¡").openPopup();

      const dateStr = document.getElementById('obs-date').value;
      const selectedHour = parseInt(document.getElementById('obs-time').value, 10);

      const selectedDate = new Date(dateStr);
      selectedDate.setHours(selectedHour, 0, 0, 0);

      const timelineStart = new Date(dateStr);
      timelineStart.setHours(18,0,0,0);

      let timelineBarHtml = '<div style="display:flex; width:100%; height:16px; border-radius:4px; overflow:hidden; margin:8px 0; border: 1px solid #555;">';
      let timelineLabelHtml = '<div style="display:flex; justify-content:space-between; color:#888; font-size:10px; padding:0 2px;">';

      for (let i=0;i<48;i++){
        const t = new Date(timelineStart.getTime() + i * 900000);
        const gc = getGalacticCorePosition(t, lat, lng);
        const moonEval = evaluateMoonImpact(t, lat, lng, gc.azimuth);
        let bg = '#222';
        if (gc.altitude > 0){
          if (gc.altitude < 15) bg = '#06a';
          else bg = moonEval.isSafe ? '#fd0' : moonEval.timelineColor;
        }
        timelineBarHtml += `<div style="flex:1; background:${bg};"></div>`;
      }
      timelineBarHtml += '</div>';

      for (let i=0;i<=12;i+=3){
        const tHour = (18 + i) % 24;
        timelineLabelHtml += `<span>${pad2(tHour)}h</span>`;
      }
      timelineLabelHtml += '</div>';

      const simStartTime = new Date(dateStr); simStartTime.setHours(12,0,0,0);
      const simEndTime = new Date(simStartTime.getTime() + 24*60*60*1000);
      let coreStart=null, coreEnd=null, goldStart=null, goldEnd=null;

      for(let t=simStartTime.getTime(); t<simEndTime.getTime(); t += 10*60000){
        const tempD = new Date(t);
        const gc = getGalacticCorePosition(tempD, lat, lng);
        const moonEval = evaluateMoonImpact(tempD, lat, lng, gc.azimuth);
        if (gc.altitude > 0){
          if(!coreStart) coreStart = new Date(t);
          coreEnd = new Date(t);
        }
        if (gc.altitude >= 15 && moonEval.isSafe){
          if(!goldStart) goldStart = new Date(t);
          goldEnd = new Date(t);
        }
      }

      const fmtTime = (d)=> d ? `${pad2(d.getHours())}:${pad2(d.getMinutes())}` : null;
      const coreWinText = coreStart ? `${fmtTime(coreStart)} ~ ${fmtTime(coreEnd)}` : "ì‹œì¦Œ ì•„ë‹˜";
      const goldWinText = goldStart ? `${fmtTime(goldStart)} ~ ${fmtTime(goldEnd)}` : "ì¡°ê±´ ë¯¸ë‹¬";

      const gcPos = getGalacticCorePosition(selectedDate, lat, lng);
      const moonEvalCurrent = evaluateMoonImpact(selectedDate, lat, lng, gcPos.azimuth);
      const lpEval = evaluateDirectionalLightPollution(lat, lng, gcPos.azimuth);

      if (gcPos.altitude > 0){
        const dist = 0.5;
        const endLat = lat + dist * Math.cos(gcPos.azimuth * Math.PI / 180);
        const endLng = lng + dist * Math.sin(gcPos.azimuth * Math.PI / 180) / Math.cos(lat * Math.PI / 180);
        coreLine = L.polyline([[lat,lng],[endLat,endLng]], { color:'#ff00ff', weight:4, dashArray:'5,10', opacity:0.8 }).addTo(map);
      }

      const withinWeather = isWithinWeatherWindow(dateStr);
      let isWeatherAvailable = false, cTotal=0, cLow=0, cMid=0, cHigh=0;
      let cloudEval = { isSafe:false, statusColor:"#aaa", statusText:"ì•Œ ìˆ˜ ì—†ìŒ" };
      let weatherWarningHtml = "";

      if(withinWeather){
        try{
          const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&hourly=cloudcover,cloudcover_low,cloudcover_mid,cloudcover_high,temperature_2m,dewpoint_2m,windspeed_10m&wind_speed_unit=ms&timezone=auto&start_date=${dateStr}&end_date=${dateStr}`;
          const response = await fetch(weatherUrl);
          if(response.ok){
            const weatherData = await response.json();
            if(weatherData.hourly && weatherData.hourly.cloudcover && weatherData.hourly.time){
              const idx = findHourlyIndex(weatherData.hourly.time, dateStr, selectedHour);
              if (idx >= 0){
                cTotal = weatherData.hourly.cloudcover[idx];
                cLow   = weatherData.hourly.cloudcover_low[idx];
                cMid   = weatherData.hourly.cloudcover_mid[idx];
                cHigh  = weatherData.hourly.cloudcover_high[idx];
                cloudEval = evaluateCloudImpact(cLow, cMid, cHigh, cTotal);
                isWeatherAvailable = true;

                const temp = weatherData.hourly.temperature_2m[idx];
                const dew  = weatherData.hourly.dewpoint_2m[idx];
                const wind = weatherData.hourly.windspeed_10m[idx];

                weatherWarningHtml = `
                  <b>ğŸŒ¡ï¸ ê¸°ì˜¨/ì´ìŠ¬ì :</b> ${temp}Â°C / ${dew}Â°C &nbsp;ğŸ‘‰ ${(temp - dew) <= 2 ? '<span class="warning-text">ğŸ’§ ê²°ë¡œ ì£¼ì˜</span>' : '<span class="safe-text">âœ… ì•ˆì „</span>'}<br>
                  <b>ğŸ’¨ í’ì†:</b> ${wind}m/s &nbsp;ğŸ‘‰ ${wind >= 5 ? '<span class="warning-text">âš ï¸ ê°•í’ ì£¼ì˜</span>' : '<span class="safe-text">âœ… ì•ˆì „</span>'}<br>
                `;
              } else {
                weatherWarningHtml = `<span class="warning-text">âš ï¸ ì‹œê°„ ë§¤ì¹­ ì‹¤íŒ¨(ì˜ˆë³´ ì‹œê°„í‘œ ë¶ˆì¼ì¹˜)</span><br>`;
              }
            }
          }
        } catch(e){ console.log("ê¸°ìƒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨", e); }
      }

      if (mySeq !== analyzeSeq) return;

      const isCoreSafe = (gcPos.altitude >= 10);
      let goTitle="", goBg="", goBorder="";
      if(isWeatherAvailable){
        if(moonEvalCurrent.isSafe && cloudEval.isSafe && isCoreSafe && lpEval.isSafe){
          goTitle="ğŸŸ¢ ë¬´ì¡°ê±´ GO! (ì§ ì‹¸ì„¸ìš”)"; goBg="rgba(0,255,100,0.2)"; goBorder="#0f0";
        } else if(!cloudEval.isSafe || (!moonEvalCurrent.isSafe && moonEvalCurrent.statusColor==="#f55") || (!lpEval.isSafe && lpEval.statusColor==="#f55")){
          goTitle="ğŸ”´ NO-GO (ì§‘ì—ì„œ ë³´ì •í•˜ì„¸ìš”)"; goBg="rgba(255,50,50,0.2)"; goBorder="#f55";
        } else {
          goTitle="ğŸŸ¡ HOLD (ë¶€ë¶„ì  ê°„ì„­ / ëŒ€ê¸°)"; goBg="rgba(255,200,0,0.2)"; goBorder="#fa0";
        }
      } else {
        if(moonEvalCurrent.isSafe && isCoreSafe && lpEval.isSafe){
          goTitle="ğŸŸ¡ GO ê°€ëŠ¥ (ë‚ ì”¨ ë¯¸í™•ì¸)"; goBg="rgba(255,200,0,0.2)"; goBorder="#fd0";
        } else {
          goTitle="âšª ë°ì´í„° ë¶€ì¡±/ë¦¬ìŠ¤í¬ (ë‚ ì”¨ ëª¨ë¦„)"; goBg="rgba(150,150,150,0.2)"; goBorder="#aaa";
        }
      }

      const rCloud = !isWeatherAvailable ? `ì•Œ ìˆ˜ ì—†ìŒ` : `<span><b style="color:${cloudEval.statusColor}">${cloudEval.statusText}</b> <span class="cloud-detail">(ìƒ${cHigh}%)</span></span>`;
      const rMoon = `<span><span style="font-size:16px; vertical-align:middle; margin-right:4px;">${moonEvalCurrent.moonEmoji}</span><b style="color:${moonEvalCurrent.statusColor}">${moonEvalCurrent.statusText}</b></span>`;
      const rCore = isCoreSafe ? `<span style="color:#0df">ê³ ë„ ${Math.round(gcPos.altitude)}Â°</span>` : `<span style="color:#f55">ê³ ë„ ${Math.round(gcPos.altitude)}Â° (ë‚®ìŒ)</span>`;
      const rLP   = `<span><b style="color:${lpEval.statusColor}">${lpEval.statusText}</b></span>`;
      const titleHtml = spotName ? `<b>ğŸ“ ${spotName}</b><br>` : `<b>ğŸ“ ê´€ì¸¡ í›„ë³´ì§€</b> (${lat.toFixed(3)}, ${lng.toFixed(3)})<br>`;

      // ë”°ì˜´í‘œ ì¹˜í™˜ (í•¨ìˆ˜ íŒŒë¼ë¯¸í„°ë¡œ ë„˜ê¸¸ ë•Œ ì˜¤ë¥˜ ë°©ì§€)
      const safeSpotName = spotName ? spotName.replace(/'/g, "\\'") : '';

      let popupText = `
        <div style="font-size: 13px; line-height: 1.6; padding-bottom:5px;">
          ${titleHtml}
          <span style="color:#aaa; font-size:11px;">ê¸°ì¤€ ì‹œê°„: ${dateStr} ${pad2(selectedHour)}:00</span><br>
          <div class="gonogo-box" style="background:${goBg}; border:1px solid ${goBorder}; margin-top:8px;">
            <div class="gonogo-title" style="color:${goBorder}">${goTitle}</div>
            <div class="gonogo-item"><span>ğŸŒ™ <b>ë‹¬ ëª¨ì–‘:</b></span> ${rMoon}</div>
            <div class="gonogo-item"><span>â˜ï¸ <b>êµ¬ë¦„:</b></span> ${rCloud}</div>
            <div class="gonogo-item"><span>ğŸŒŒ <b>ì½”ì–´:</b></span> ${rCore}</div>
            <div class="gonogo-item"><span>ğŸ’¡ <b>ê´‘í•´ë°©í–¥:</b></span> ${rLP}</div>
          </div>
          <div class="mw-window-box">
            <div style="font-size:15px; font-weight:bold; color:#fff; text-align:center; margin-bottom:6px;">ğŸŒŒ Milky Way Window</div>
            ${timelineBarHtml}
            ${timelineLabelHtml}
            <div class="timeline-legend">
              <div class="legend-item"><div class="legend-box" style="background:#06a;"></div>ì½”ì–´ ë‚®ìŒ</div>
              <div class="legend-item"><div class="legend-box" style="background:#635;"></div>ë‹¬ ì”»ê¹€</div>
              <div class="legend-item"><div class="legend-box" style="background:#c60;"></div>ì €ê³ ë„ë‹¬</div>
              <div class="legend-item"><div class="legend-box" style="background:#f00;"></div>ë‹¬ ê²¹ì¹¨</div>
              <div class="legend-item"><div class="legend-box" style="background:#fd0;"></div><b style="color:#fd0;">ì‹¤ì „(15Â°â†‘)</b></div>
            </div>
            <hr style="border-top:1px dashed #555; margin:10px 0;">
            <div style="font-size:12.5px; text-align:center;">
              ì½”ì–´ ì§€í‰ì„  ìœ„: <span style="color:#0df">${coreWinText}</span><br>
              <span style="font-size:14px;">âœ¨ <b>ì‹¤ì „ ê³¨ë“  ìœˆë„ìš°:</b> <span style="color:#fd0; font-weight:900;">${goldWinText}</span></span>
            </div>
          </div>
      `;
      if (isWeatherAvailable || weatherWarningHtml) popupText += `${weatherWarningHtml}`;

      popupText += `
        <button class="btn-capture" onclick="capturePopup(event, this)">
          ğŸ“¸ ê²°ê³¼ ìº¡ì²˜í•˜ì—¬ ì €ì¥í•˜ê¸°
        </button>
        <button class="btn-favorite" onclick="saveFavorite(event, ${lat}, ${lng}, '${safeSpotName}')">
          â­ ì´ ì¥ì†Œ ì¦ê²¨ì°¾ê¸°ì— ì €ì¥
        </button>
      </div>`;

      marker.bindPopup(popupText).openPopup();
    }

    window.capturePopup = function(ev, btnElement) {
      if (ev) { ev.preventDefault(); ev.stopPropagation(); }

      const popupEl = document.querySelector('.leaflet-popup');
      if (!popupEl) return;

      popupEl.addEventListener('click', (e) => { e.stopPropagation(); }, { once: true });

      const originalText = btnElement.innerText;
      btnElement.innerText = "â³ ì´ë¯¸ì§€ ì €ì¥ ì¤‘...";
      btnElement.style.pointerEvents = "none";

      html2canvas(popupEl, {
        backgroundColor: "#1e1e1e",
        scale: 2,
        useCORS: true
      }).then(canvas => {
        const dateStr = document.getElementById('obs-date').value;
        const link = document.createElement('a');
        link.download = `MilkyWay_ê²°ê³¼_${dateStr}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();

        btnElement.innerText = originalText;
        btnElement.style.pointerEvents = "auto";
      }).catch(err => {
        alert("ì´ë¯¸ì§€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        btnElement.innerText = originalText;
        btnElement.style.pointerEvents = "auto";
        console.error(err);
      });
    };

    function calculateBestDate(){
      let bestDate=null, minFraction=1.0, bestEmoji="ğŸŒ‘";
      for(let i=0;i<=30;i++){
        const testD = new Date();
        testD.setDate(testD.getDate() + i);
        testD.setHours(12,0,0,0);
        const moon = SunCalc.getMoonIllumination(testD);
        if(moon.fraction < minFraction){
          minFraction = moon.fraction;
          bestDate = testD;
          bestEmoji = getMoonPhaseEmoji(moon.phase);
        }
      }
      if(bestDate){
        const bY = bestDate.getFullYear(), bM = pad2(bestDate.getMonth()+1), bD = pad2(bestDate.getDate());
        const bestStr = `${bY}-${bM}-${bD}`;
        document.getElementById('best-date-box').innerHTML =
          `<div style="font-size:16px; font-weight:bold; color:#0df;">${bY}ë…„ ${bM}ì›” ${bD}ì¼</div>
           <div style="font-size:13px; color:#aaa; margin-top:4px;">
             ${bestEmoji} ì˜ˆìƒ ë‹¬ë¹›: ${Math.round(minFraction*100)}%
           </div>
           <div style="font-size:11px; color:#777; margin-top:4px;">í´ë¦­í•˜ì—¬ ë‚ ì§œ ì ìš©</div>`;
        document.getElementById('best-date-box').onclick = function(){
          document.getElementById('obs-date').value = bestStr;
          updateWeatherModeUI();
          if(currentLat!=null) analyzeData(currentLat, currentLng);
        };
      }
    }
    calculateBestDate();

    const candidateSpots = [
      { name: "ì—°ì²œ ë‹¹í¬ì„± (ê²½ê¸° ë¶ë¶€)", lat: 38.013, lng: 126.949 },
      { name: "íŒŒì£¼ ê°ì•…ì‚° ë¶€ê·¼ (ê²½ê¸° ë¶ë¶€)", lat: 37.942, lng: 126.960 },
      { name: "ì–‘í‰ ë²—ê³ ê°œ (ê²½ê¸° ë™ë¶€)", lat: 37.534, lng: 127.387 },
      { name: "ê°•ë¦‰ ì•ˆë°˜ë°ê¸° (ê°•ì› ì˜ë™)", lat: 37.615, lng: 128.823 },
      { name: "í™”ì²œ ì¡°ê²½ì² ì²œë¬¸ëŒ€ (ê°•ì› ì˜ì„œ)", lat: 38.125, lng: 127.461 },
      { name: "íƒœë°± ë§¤ë´‰ì‚° ë°”ëŒì˜ì–¸ë• (ê°•ì›)", lat: 37.218, lng: 128.981 },
      { name: "í•©ì²œ í™©ë§¤ì‚° (ê²½ë‚¨)", lat: 35.582, lng: 127.975 },
      { name: "ë¶€ì—¬ ì‚¬ë‘ë‚˜ë¬´ (ì¶©ë‚¨)", lat: 36.257, lng: 126.903 }
    ];

    validateSpots(candidateSpots);

    document.getElementById('btn-simulate').addEventListener('click', async function(){
      const btn = this;
      const msg = document.getElementById('simulate-msg');
      const targetDate = document.getElementById('obs-date').value;
      const progContainer = document.getElementById('progress-container');
      const progBar = document.getElementById('progress-bar');

      if(!isWithinWeatherWindow(targetDate)){
        msg.style.display='block'; msg.style.color='#fd0';
        msg.innerText='âš ï¸ 14ì¼ ì´í›„ëŠ” ë‚ ì”¨ ê¸°ë°˜ ì‹œë®¬ë ˆì´ì…˜ ë¶ˆê°€(ë‹¬/ê´‘í•´/ì½”ì–´ë§Œ í™•ì¸í•˜ì„¸ìš”).';
        return;
      }

      if(!validateSpots(candidateSpots)){
        msg.style.display='block'; msg.style.color='#f55';
        msg.innerText='âŒ í›„ë³´ì§€ ë°ì´í„°ì— ì˜¤ë¥˜ê°€ ìˆì–´ ì‹œë®¬ë ˆì´ì…˜ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤. (Console í™•ì¸)';
        return;
      }

      btn.disabled = true;
      msg.style.display = 'block';
      msg.style.color = '#0df';
      msg.innerText = "êµ­ë‚´ ì£¼ìš” ëª…ì†Œë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤.";
      progContainer.style.display = 'block';
      progBar.style.width = '0%';

      let bestScore = -1, bestSpot = null, bestHour = 22;
      const searchHours = [0,1,2,3,4,20,21,22,23];

      try{
        for(let i=0; i<candidateSpots.length; i++){
          const spot = candidateSpots[i];

          const percentage = Math.round(((i + 1) / candidateSpots.length) * 100);
          btn.innerHTML = `ğŸ“¡ ë¶„ì„ ì¤‘... (${percentage}%)`;
          progBar.style.width = `${percentage}%`;
          await new Promise(r => setTimeout(r, 50));

          const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${spot.lat}&longitude=${spot.lng}&hourly=cloudcover,cloudcover_low,cloudcover_mid,cloudcover_high&timezone=auto&start_date=${targetDate}&end_date=${targetDate}`;
          const response = await fetch(weatherUrl);
          if(!response.ok) continue;

          const weatherData = await response.json();
          if(!weatherData.hourly || !weatherData.hourly.cloudcover || !weatherData.hourly.time) continue;

          for(const h of searchHours){
            const idx = findHourlyIndex(weatherData.hourly.time, targetDate, h);
            if (idx < 0) continue;

            const cTotal = weatherData.hourly.cloudcover[idx];
            const cLow   = weatherData.hourly.cloudcover_low[idx];
            const cMid   = weatherData.hourly.cloudcover_mid[idx];
            const cHigh  = weatherData.hourly.cloudcover_high[idx];

            const d = new Date(targetDate); d.setHours(h,0,0,0);
            const gcPos = getGalacticCorePosition(d, spot.lat, spot.lng);
            const moonEval = evaluateMoonImpact(d, spot.lat, spot.lng, gcPos.azimuth);
            const cloudEval = evaluateCloudImpact(cLow, cMid, cHigh, cTotal);
            const lpEval = evaluateDirectionalLightPollution(spot.lat, spot.lng, gcPos.azimuth);

            let score = 100 - (cTotal * 0.4) - (cLow * 0.2) - (cMid * 0.4) - (cHigh * 1.5) - ((lpEval.bortleClass - 1) * 8);

            if(!moonEval.isSafe) score -= 30;
            if(moonEval.timelineColor === "#f00") score -= 60;
            if(!cloudEval.isSafe) score -= 50;
            if(!lpEval.isSafe) score -= 40;
            if(gcPos.altitude <= 0) score -= 40;

            if(score > bestScore){ bestScore = score; bestSpot = spot; bestHour = h; }
          }
        }

        if(bestSpot && bestScore > 0){
          document.getElementById('obs-time').value = bestHour;
          document.getElementById('time-text').innerText = `${pad2(bestHour)}:00`;
          msg.style.color = "#0df";
          msg.innerText = `âœ… [${bestSpot.name}] ${bestHour}ì‹œê°€ ê°€ì¥ ìµœì ì…ë‹ˆë‹¤!`;
          map.setView([bestSpot.lat, bestSpot.lng], 11);
          analyzeData(bestSpot.lat, bestSpot.lng, bestSpot.name);

          if(window.innerWidth <= 768) {
            document.getElementById('ui-panel').classList.add('collapsed');
          }
        } else {
          msg.style.color = "#f55";
          msg.innerText = "âŒ ê¸°ìƒ ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ì¡°ê±´ì´ ë§ëŠ” ê³³ì´ ì—†ìŠµë‹ˆë‹¤.";
        }
      } catch(err){
        msg.style.color = "#f55";
        msg.innerText = "ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        console.log(err);
      } finally {
        btn.disabled = false;
        btn.innerHTML = "ğŸš€ ì„ íƒí•œ ë‚ ì§œì˜ ìµœì ì§€ ì°¾ê¸°";
        setTimeout(() => { progContainer.style.display = 'none'; }, 1000);
      }
    });

    document.getElementById('map-theme').addEventListener('change', function(e){
      map.removeLayer(currentBaseLayer);
      currentBaseLayer = e.target.value === 'dark' ? darkLayer : (e.target.value === 'satellite' ? satelliteLayer : standardLayer);
      currentBaseLayer.addTo(map);
    });

    document.getElementById('light-pollution-toggle').addEventListener('change', function(e){
      e.target.checked ? lightPollutionLayer.addTo(map) : map.removeLayer(lightPollutionLayer);
    });

    document.getElementById('lp-opacity').addEventListener('input', function(e){
      lightPollutionLayer.setOpacity(e.target.value);
      document.getElementById('opacity-val').innerText = Math.round(e.target.value * 100);
    });

    document.getElementById('btn-today').addEventListener('click', function(){
      document.getElementById('obs-date').value = fmtYMD(getToday());
      updateWeatherModeUI();
      if(currentLat!=null) analyzeData(currentLat, currentLng);
    });

    document.getElementById('obs-time').addEventListener('input', function(e){
      document.getElementById('time-text').innerText = `${pad2(e.target.value)}:00`;
    });

    document.getElementById('obs-time').addEventListener('change', function(){
      if(currentLat!=null) analyzeData(currentLat, currentLng);
    });

    document.getElementById('obs-date').addEventListener('change', function(){
      updateWeatherModeUI();
      if(currentLat!=null) analyzeData(currentLat, currentLng);
      const m = document.getElementById('simulate-msg');
      if(isWithinWeatherWindow(document.getElementById('obs-date').value)){ m.style.display='none'; }
    });

    map.on('click', function(e){ analyzeData(e.latlng.lat, e.latlng.lng); });

    updateWeatherModeUI();
  </script>
</body>
</html>