<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì€í•˜ìˆ˜ ê´€ì¸¡ í™•ë¥  ê³„ì‚°ê¸° Pro Max</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; }
        #map { width: 100vw; height: 100vh; }
        
        #ui-panel {
            position: absolute; top: 20px; right: 20px; z-index: 1000;
            background: rgba(30, 30, 30, 0.85); backdrop-filter: blur(10px); color: white;
            padding: 20px; border-radius: 12px; font-family: sans-serif;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); width: 270px; max-height: 90vh; overflow-y: auto;
        }
        #ui-panel::-webkit-scrollbar { width: 8px; }
        #ui-panel::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 4px; }
        
        .ui-section { margin-bottom: 15px; }
        .ui-section:last-child { margin-bottom: 0; }
        .ui-title { font-size: 14px; font-weight: bold; margin-bottom: 8px; color: #aaa; }
        
        select, input[type="date"], button {
            width: 100%; padding: 8px; margin-top: 5px; background: rgba(255, 255, 255, 0.1);
            color: white; border: 1px solid #555; border-radius: 6px; cursor: pointer; box-sizing: border-box;
        }
        select option { background: #333; }
        button:hover { background: rgba(255, 255, 255, 0.2); }
        
        .date-row { display: flex; gap: 8px; }
        .date-row input { flex: 2; margin-top: 0; }
        .date-row button { flex: 1; margin-top: 0; }
        label { cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 14px; }
        input[type="range"] { width: 100%; margin-top: 5px; cursor: pointer; }
        
        .time-display-box { text-align: center; font-size: 18px; font-weight: bold; color: #0df; margin-bottom: 5px; }

        .leaflet-popup-content-wrapper, .leaflet-popup-tip {
            background: rgba(20, 20, 20, 0.95) !important; backdrop-filter: blur(10px) !important;
            -webkit-backdrop-filter: blur(10px) !important; color: #ffffff !important; box-shadow: 0 4px 15px rgba(0,0,0,0.8) !important;
            width: 320px; 
        }
        .leaflet-popup-content hr { border: 0; border-top: 1px solid rgba(255, 255, 255, 0.15); margin: 10px 0; }
        
        .score-box { padding: 8px; border-radius: 6px; text-align: center; margin-top: 10px; font-size: 16px; }
        .dark-map-filter { filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%) grayscale(20%); }
        .opacity-control { display: flex; align-items: center; gap: 10px; margin-top: 5px; font-size: 12px; }
        .opacity-label { min-width: 75px; }
        .best-date-box { background: rgba(0, 255, 255, 0.1); border: 1px solid rgba(0, 255, 255, 0.3); padding: 10px; border-radius: 6px; text-align: center; cursor: pointer; transition: 0.2s; }
        .best-date-box:hover { background: rgba(0, 255, 255, 0.2); }
        .notice-text { font-size: 11px; color: #999; margin-top: 8px; line-height: 1.4; word-break: keep-all; }
        .btn-simulate { background: rgba(0, 255, 100, 0.2); border: 1px solid #0f0; color: #0f0; font-weight: bold; padding: 12px; margin-top: 10px; transition: 0.3s; }
        .btn-simulate:hover { background: rgba(0, 255, 100, 0.4); color: white; }
        .btn-simulate:disabled { background: rgba(100, 100, 100, 0.2); border-color: #555; color: #888; cursor: not-allowed; }
        
        .gonogo-box { padding: 10px; border-radius: 8px; margin-bottom: 12px; text-align: left; font-size: 13px; line-height: 1.6; }
        .gonogo-title { font-size: 18px; font-weight: 900; text-align: center; margin-bottom: 8px; letter-spacing: 1px; }
        .gonogo-item { display: flex; justify-content: space-between; margin-bottom: 4px; border-bottom: 1px dashed rgba(255,255,255,0.1); padding-bottom: 4px; }
        .gonogo-item:last-child { border-bottom: none; padding-bottom: 0; }

        .mw-window-box { background: rgba(0, 0, 0, 0.5); border: 1px solid #444; padding: 12px; border-radius: 8px; margin-bottom: 12px; }
        .timeline-legend { display: flex; gap: 6px; font-size: 10px; justify-content: center; margin-top: 6px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 4px; color: #ddd; }
        .legend-box { width: 10px; height: 10px; border-radius: 2px; }
        
        .cloud-detail { font-size: 11px; color: #aaa; font-weight: normal; }
        .warning-text { color: #ff5555; font-weight: bold; font-size: 12px; }
        .safe-text { color: #55ff55; font-size: 12px; }
    </style>
</head>
<body>
    <div id="ui-panel">
        <div class="ui-section">
            <div class="ui-title">ğŸ—ºï¸ ì§€ë„ í…Œë§ˆ</div>
            <select id="map-theme">
                <option value="dark">ë‹¤í¬ ëª¨ë“œ (ê´€ì¸¡ ìµœì í™”)</option>
                <option value="satellite">ìœ„ì„± ì§€ë„ (ì§€í˜• í™•ì¸ìš©)</option>
                <option value="standard">ì¼ë°˜ ì§€ë„</option>
            </select>
        </div>

        <div class="ui-section">
            <div class="ui-title">âœ¨ ê´‘í•´ ì§€ë„</div>
            <label><input type="checkbox" id="light-pollution-toggle" checked> ì˜¤ë²„ë ˆì´ ì¼œê¸°</label>
            <div class="opacity-control">
                <span class="opacity-label">íˆ¬ëª…ë„ (<span id="opacity-val">60</span>%)</span>
                <input type="range" id="lp-opacity" min="0" max="1" step="0.1" value="0.6">
            </div>
        </div>

        <div class="ui-section">
            <div class="ui-title">ğŸ“… ê´€ì¸¡ ì˜ˆì •ì¼</div>
            <div class="date-row">
                <input type="date" id="obs-date">
                <button id="btn-today">ì˜¤ëŠ˜</button>
            </div>
            <div class="notice-text">â€» ê¸°ìƒ ì˜ˆë³´ëŠ” ìµœëŒ€ 14ì¼ê¹Œì§€ë§Œ ì œê³µë˜ë©°, ì´í›„ ë‚ ì§œëŠ” ë‹¬ë¹›ê³¼ ê´‘í•´ ì •ë³´ë§Œ í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>

        <div class="ui-section">
            <div class="ui-title">â° ê´€ì¸¡ ì‹œê°„</div>
            <div class="time-display-box" id="time-text">22:00</div>
            <input type="range" id="obs-time" min="0" max="23" value="22">
        </div>

        <div class="ui-section" id="best-date-section">
            <div class="ui-title">ğŸ”­ ë‹¤ìŒ ê´€ì¸¡ ìµœì ê¸° ì¶”ì²œ</div>
            <div class="best-date-box" id="best-date-box">ê³„ì‚° ì¤‘...</div>
            <button id="btn-simulate" class="btn-simulate">ğŸš€ ì„ íƒí•œ ë‚ ì§œì˜ ìµœì ì§€ ì°¾ê¸°</button>
            <div id="simulate-msg" class="notice-text" style="display: none; color: #0df;"></div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
    
    <script>
        var today = new Date(); var yyyy = today.getFullYear(); var mm = String(today.getMonth() + 1).padStart(2, '0'); var dd = String(today.getDate()).padStart(2, '0');
        document.getElementById('obs-date').value = `${yyyy}-${mm}-${dd}`;
        var map = L.map('map').setView([38.09, 127.07], 10);

        var darkLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}&hl=ko', { className: 'dark-map-filter', maxZoom: 19, zIndex: 1 });
        var satelliteLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}&hl=ko', { maxZoom: 19, zIndex: 1 });
        var standardLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}&hl=ko', { maxZoom: 19, zIndex: 1 });
        var currentBaseLayer = darkLayer; currentBaseLayer.addTo(map);

        var lightPollutionLayer = L.tileLayer('https://tiles.arcgis.com/tiles/b3fMqPOmotX6SV4k/arcgis/rest/services/ArtificialSkyBrightness/MapServer/tile/{z}/{y}/{x}', { opacity: 0.6, maxNativeZoom: 6, maxZoom: 19, zIndex: 10 }).addTo(map);

        function getGalacticCorePosition(date, lat, lng) {
            const RA = 266.4168, Dec = -29.0078, rad = Math.PI / 180;
            const jd = (date.getTime() / 86400000) + 2440587.5; const d = jd - 2451545.0;
            let LST = (280.46061837 + 360.98564736629 * d + lng) % 360; if (LST < 0) LST += 360;
            let HA = LST - RA; if (HA < 0) HA += 360;
            let HA_rad = HA * rad, Dec_rad = Dec * rad, Lat_rad = lat * rad;
            let sinAlt = Math.sin(Dec_rad) * Math.sin(Lat_rad) + Math.cos(Dec_rad) * Math.cos(Lat_rad) * Math.cos(HA_rad);
            let alt = Math.asin(sinAlt) / rad;
            let cosAz = (Math.sin(Dec_rad) - Math.sin(Lat_rad) * sinAlt) / (Math.cos(Lat_rad) * Math.cos(Math.asin(sinAlt)));
            let az = Math.acos(cosAz) / rad; if (Math.sin(HA_rad) > 0) az = 360 - az;
            return { altitude: alt, azimuth: az };
        }

        function evaluateMoonImpact(date, lat, lng, gcAzimuth) {
            let moonIllum = Math.round(SunCalc.getMoonIllumination(date).fraction * 100);
            let mPos = SunCalc.getMoonPosition(date, lat, lng);
            let mAlt = mPos.altitude * 180 / Math.PI;
            let mAz = (mPos.azimuth * 180 / Math.PI) + 180; 
            let azDiff = Math.abs(mAz - gcAzimuth);
            if (azDiff > 180) azDiff = 360 - azDiff;

            let isSafe = false, statusColor = "", statusText = "", timelineColor = "";

            if (mAlt < 0) {
                isSafe = true; statusColor = "#0df"; statusText = `ğŸŸ¢ ì™„ë²½ ì°¨ë‹¨ (-${Math.abs(Math.round(mAlt))}Â°)`; timelineColor = "#fd0";
            } else if (moonIllum < 15) {
                isSafe = true; statusColor = "#0df"; statusText = `ğŸŸ¢ ì˜í–¥ ë¯¸ë¯¸ (${moonIllum}%)`; timelineColor = "#fd0";
            } else {
                if (azDiff < 40 && mAlt > 0) {
                    statusColor = "#f55"; statusText = `ğŸ”´ ì½”ì–´ ë°©í•´ (ë‹¬ ê²¹ì¹¨!)`; timelineColor = "#f00";
                } else if (mAlt > 10) {
                    statusColor = "#f55"; statusText = `ğŸ”´ ë‹¬ë¹› ì”»ê¹€ (ê³ ë„ ${Math.round(mAlt)}Â°)`; timelineColor = "#635";
                } else {
                    statusColor = "#fa0"; statusText = `ğŸŸ¡ ì €ê³ ë„ ê°„ì„­ ì£¼ì˜`; timelineColor = "#c60";
                }
            }
            return { isSafe, statusColor, statusText, timelineColor };
        }

        function evaluateCloudImpact(cLow, cMid, cHigh, cTotal) {
            let isSafe = false, statusColor = "", statusText = "";
            if (cHigh >= 20) { isSafe = false; statusColor = "#f55"; statusText = `ğŸ”´ ìƒì¸µìš´ ì¹˜ëª…ì `; } 
            else if (cTotal >= 35) { isSafe = false; statusColor = "#f55"; statusText = `ğŸ”´ êµ¬ë¦„ ë§ìŒ (ê´€ì¸¡ ë¶ˆê°€)`; } 
            else if (cTotal > 15 || cHigh > 10) { isSafe = true; statusColor = "#fa0"; statusText = `ğŸŸ¡ ì•½ê°„ íë¦¼`; } 
            else { isSafe = true; statusColor = "#0df"; statusText = `ğŸŸ¢ ì¾Œì²­`; }
            return { isSafe, statusColor, statusText };
        }

        // ğŸŒŸ ìƒˆë¡œ ì¶”ê°€ëœ í•¨ìˆ˜: ê±°ëŒ€ ê´‘í•´ ë”(Light Dome) ë°©í–¥ì„± ì¶”ì ê¸°
        function evaluateDirectionalLightPollution(lat, lng, coreAzimuth) {
            // ì„œìš¸ ì¤‘ì‹¬ (ëŒ€í•œë¯¼êµ­ ìµœëŒ€ ê´‘í•´ ì†ŒìŠ¤)
            const seoulLat = 37.5665, seoulLng = 126.9780;
            
            // 1. ê´€ì¸¡ì§€ë¡œë¶€í„° ì„œìš¸ê¹Œì§€ì˜ ëŒ€ëµì ì¸ ê±°ë¦¬ ê³„ì‚° (km)
            const R = 6371; 
            const dLat = (seoulLat - lat) * Math.PI / 180;
            const dLon = (seoulLng - lng) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat * Math.PI / 180) * Math.cos(seoulLat * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            const distance = R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));

            // 2. ê´€ì¸¡ì§€ì—ì„œ ì„œìš¸ì„ ë°”ë¼ë³´ëŠ” ë°©ìœ„ê°(Bearing) ê³„ì‚°
            const y = Math.sin(dLon) * Math.cos(seoulLat * Math.PI / 180);
            const x = Math.cos(lat * Math.PI / 180) * Math.sin(seoulLat * Math.PI / 180) - Math.sin(lat * Math.PI / 180) * Math.cos(seoulLat * Math.PI / 180) * Math.cos(dLon);
            let bearingToSeoul = Math.atan2(y, x) * 180 / Math.PI;
            bearingToSeoul = (bearingToSeoul + 360) % 360;

            // 3. ì€í•˜ìˆ˜ ì½”ì–´ ë°©í–¥ê³¼ ê´‘í•´ ë”(ì„œìš¸) ë°©í–¥ì˜ ì°¨ì´ ê³„ì‚°
            let angleDiff = Math.abs(coreAzimuth - bearingToSeoul);
            if (angleDiff > 180) angleDiff = 360 - angleDiff;

            let isSafe = true;
            let statusColor = "";
            let statusText = "";

            if (distance < 15) {
                // ì„œìš¸ í•œë³µíŒ
                isSafe = false; statusColor = "#f55"; statusText = `ğŸ”´ ë„ì‹¬ ë‚´ë¶€ (ì „ë°©ìœ„ ê´‘í•´)`;
            } else if (distance < 65 && angleDiff < 35) {
                // ì„œìš¸ì—ì„œ ë°˜ê²½ 65km ì´ë‚´(ì—°ì²œ, ì–‘í‰ ì¼ë¶€ ë“±)ì´ë©´ì„œ, ì½”ì–´ ë°©í–¥ì´ ì„œìš¸ ìª½ì¼ ë•Œ
                isSafe = false; statusColor = "#f55"; statusText = `ğŸ”´ ì½”ì–´ ë°©í–¥ ê±°ëŒ€ ê´‘í•´ (ë¹›ê·¸ë¬¼)`;
            } else if (distance < 90 && angleDiff < 45) {
                // ê°„ì„­ì´ ì‚´ì§ ìˆëŠ” ë²”ìœ„
                isSafe = true; statusColor = "#fa0"; statusText = `ğŸŸ¡ ì§€í‰ì„  ê´‘í•´ ê°„ì„­ ì£¼ì˜`;
            } else {
                // ê´‘í•´ë¥¼ ë“±ì§€ê³  ìˆê±°ë‚˜(ë‚¨ìª½ ì§€ì—­), ê±°ë¦¬ê°€ ì•„ì£¼ ë©€ ë•Œ
                isSafe = true; statusColor = "#0df"; statusText = `ğŸŸ¢ ì½”ì–´ ë°©í–¥ ì§€í‰ì„  ì–´ë‘ì›€`;
            }

            // ë¶€ê°€ ì •ë³´: ê±°ë¦¬ ê¸°ë°˜ ê¸°ì´ˆ ë“±ê¸‰
            let bortleClass = distance < 15 ? 8 : (distance < 30 ? 6 : (distance < 50 ? 4 : (distance < 80 ? 3 : 2)));

            return { isSafe, statusColor, statusText, bortleClass, angleDiff };
        }

        var marker = null, coreLine = null, currentLat = null, currentLng = null;

        async function analyzeData(lat, lng, spotName = null) {
            currentLat = lat; currentLng = lng;
            if (marker) map.removeLayer(marker); if (coreLine) map.removeLayer(coreLine); 
            marker = L.marker([lat, lng]).addTo(map); marker.bindPopup("ë°ì´í„° ë¶„ì„ ì¤‘... ğŸ“¡").openPopup();
            
            var dateStr = document.getElementById('obs-date').value;
            var selectedHour = parseInt(document.getElementById('obs-time').value);
            var selectedDate = new Date(dateStr); selectedDate.setHours(selectedHour);
            
            var simStartTime = new Date(dateStr); simStartTime.setHours(12, 0, 0, 0);
            var simEndTime = new Date(simStartTime.getTime() + 24 * 60 * 60 * 1000);
            var coreStart = null, coreEnd = null, goldStart = null, goldEnd = null;

            var timelineStart = new Date(dateStr); timelineStart.setHours(18, 0, 0, 0);
            var timelineBarHtml = '<div style="display:flex; width:100%; height:16px; border-radius:4px; overflow:hidden; margin:8px 0; border: 1px solid #555;">';
            var timelineLabelHtml = '<div style="display:flex; justify-content:space-between; color:#888; font-size:10px; padding:0 2px;">';
            
            for (let i = 0; i < 48; i++) {
                let t = new Date(timelineStart.getTime() + i * 900000);
                let gc = getGalacticCorePosition(t, lat, lng);
                let moonEval = evaluateMoonImpact(t, lat, lng, gc.azimuth);
                let bg = '#222'; 
                if (gc.altitude > 0) {
                    if (gc.altitude < 15) bg = '#06a'; 
                    else bg = moonEval.isSafe ? '#fd0' : moonEval.timelineColor; 
                }
                timelineBarHtml += `<div style="flex:1; background:${bg};"></div>`;
            }
            timelineBarHtml += '</div>';

            for (let i = 0; i <= 12; i += 3) {
                let tHour = (18 + i) % 24; timelineLabelHtml += `<span>${String(tHour).padStart(2,'0')}h</span>`;
            }
            timelineLabelHtml += '</div>';

            for(let t = simStartTime.getTime(); t < simEndTime.getTime(); t += 10 * 60000) {
                let tempD = new Date(t);
                let gc = getGalacticCorePosition(tempD, lat, lng);
                let moonEval = evaluateMoonImpact(tempD, lat, lng, gc.azimuth);

                if (gc.altitude > 0) {
                    if (!coreStart) coreStart = new Date(t);
                    coreEnd = new Date(t); 
                }
                if (gc.altitude >= 15 && moonEval.isSafe) {
                    if (!goldStart) goldStart = new Date(t);
                    goldEnd = new Date(t);
                }
            }

            const fmtTime = (d) => d ? String(d.getHours()).padStart(2,'0') + ":" + String(d.getMinutes()).padStart(2,'0') : null;
            let coreWinText = coreStart ? `${fmtTime(coreStart)} ~ ${fmtTime(coreEnd)}` : "ì‹œì¦Œ ì•„ë‹˜";
            let goldWinText = goldStart ? `${fmtTime(goldStart)} ~ ${fmtTime(goldEnd)}` : "ì¡°ê±´ ë¯¸ë‹¬";

            var gcPos = getGalacticCorePosition(selectedDate, lat, lng);
            var moonEvalCurrent = evaluateMoonImpact(selectedDate, lat, lng, gcPos.azimuth);
            
            // ğŸŒŸ ë°©í–¥ì„± ê´‘í•´ ì¶”ì ê¸° í˜¸ì¶œ
            var lpEval = evaluateDirectionalLightPollution(lat, lng, gcPos.azimuth);

            if (gcPos.altitude > 0) {
                let dist = 0.5; let endLat = lat + dist * Math.cos(gcPos.azimuth * Math.PI / 180);
                let endLng = lng + dist * Math.sin(gcPos.azimuth * Math.PI / 180) / Math.cos(lat * Math.PI / 180);
                coreLine = L.polyline([[lat, lng], [endLat, endLng]], { color: '#ff00ff', weight: 4, dashArray: '5, 10', opacity: 0.8 }).addTo(map);
            }

            var isWeatherAvailable = false;
            var cTotal = 0, cLow = 0, cMid = 0, cHigh = 0;
            var cloudEval = { isSafe: false, statusColor: "#aaa", statusText: "ì•Œ ìˆ˜ ì—†ìŒ" };
            var weatherWarningHtml = "";

            try {
                var weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&hourly=cloudcover,cloudcover_low,cloudcover_mid,cloudcover_high,temperature_2m,dewpoint_2m,windspeed_10m&wind_speed_unit=ms&timezone=auto&start_date=${dateStr}&end_date=${dateStr}`;
                var response = await fetch(weatherUrl); 
                if(response.ok) {
                    var weatherData = await response.json();
                    if(weatherData.hourly && weatherData.hourly.cloudcover) {
                        cTotal = weatherData.hourly.cloudcover[selectedHour]; cLow = weatherData.hourly.cloudcover_low[selectedHour]; cMid = weatherData.hourly.cloudcover_mid[selectedHour]; cHigh = weatherData.hourly.cloudcover_high[selectedHour];
                        cloudEval = evaluateCloudImpact(cLow, cMid, cHigh, cTotal);
                        isWeatherAvailable = true;
                        
                        let temp = weatherData.hourly.temperature_2m[selectedHour]; let dew = weatherData.hourly.dewpoint_2m[selectedHour]; let wind = weatherData.hourly.windspeed_10m[selectedHour];
                        weatherWarningHtml = `
                            <b>ğŸŒ¡ï¸ ê¸°ì˜¨/ì´ìŠ¬ì :</b> ${temp}Â°C / ${dew}Â°C &nbsp;ğŸ‘‰ ${(temp - dew) <= 2 ? '<span class="warning-text">ğŸ’§ ê²°ë¡œ ì£¼ì˜</span>' : '<span class="safe-text">âœ… ì•ˆì „</span>'}<br>
                            <b>ğŸ’¨ í’ì†:</b> ${wind}m/s &nbsp;ğŸ‘‰ ${wind >= 5 ? '<span class="warning-text">âš ï¸ ê°•í’ ì£¼ì˜</span>' : '<span class="safe-text">âœ… ì•ˆì „</span>'}<br>
                        `;
                    }
                }
            } catch (error) { console.log("ê¸°ìƒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨"); }

            let isCoreSafe = (gcPos.altitude >= 10);

            // ğŸŒŸ 4ëŒ€ í•µì‹¬(ë‹¬, êµ¬ë¦„, ì½”ì–´, ê´‘í•´ ë°©í–¥) í†µí•© íŒë…
            let goTitle = "", goBg = "", goBorder = "";
            if (isWeatherAvailable) {
                if (moonEvalCurrent.isSafe && cloudEval.isSafe && isCoreSafe && lpEval.isSafe) { 
                    goTitle = "ğŸŸ¢ ë¬´ì¡°ê±´ GO! (ì§ ì‹¸ì„¸ìš”)"; goBg = "rgba(0,255,100,0.2)"; goBorder = "#0f0"; 
                } 
                else if (!cloudEval.isSafe || (!moonEvalCurrent.isSafe && moonEvalCurrent.statusColor === "#f55") || (!lpEval.isSafe && lpEval.statusColor === "#f55")) { 
                    goTitle = "ğŸ”´ NO-GO (ì§‘ì—ì„œ ë³´ì •í•˜ì„¸ìš”)"; goBg = "rgba(255,50,50,0.2)"; goBorder = "#f55"; 
                } 
                else { 
                    goTitle = "ğŸŸ¡ HOLD (ë¶€ë¶„ì  ê°„ì„­ / ëŒ€ê¸°)"; goBg = "rgba(255,200,0,0.2)"; goBorder = "#fa0"; 
                }
            } else { 
                goTitle = "âšª ë°ì´í„° ë¶€ì¡± (ë‚ ì”¨ ëª¨ë¦„)"; goBg = "rgba(150,150,150,0.2)"; goBorder = "#aaa"; 
            }

            let rCloud = !isWeatherAvailable ? `ì•Œ ìˆ˜ ì—†ìŒ` : `<span><b style="color:${cloudEval.statusColor}">${cloudEval.statusText}</b> <span class="cloud-detail">(ìƒ${cHigh}%)</span></span>`;
            let rMoon = `<span><b style="color:${moonEvalCurrent.statusColor}">${moonEvalCurrent.statusText}</b></span>`;
            let rCore = isCoreSafe ? `<span style="color:#0df">ê³ ë„ ${Math.round(gcPos.altitude)}Â°</span>` : `<span style="color:#f55">ê³ ë„ ${Math.round(gcPos.altitude)}Â° (ë‚®ìŒ)</span>`;
            
            // ğŸŒŸ ê´‘í•´ ë°©í–¥ì„± í‘œì‹œ UI ì¶”ê°€
            let rLP = `<span><b style="color:${lpEval.statusColor}">${lpEval.statusText}</b></span>`;

            var titleHtml = spotName ? `<b>ğŸ“ ${spotName}</b><br>` : `<b>ğŸ“ ê´€ì¸¡ í›„ë³´ì§€</b> (${lat.toFixed(3)}, ${lng.toFixed(3)})<br>`;
            
            var popupText = `
                <div style="font-size: 13px; line-height: 1.6;">
                    ${titleHtml}
                    <span style="color:#aaa; font-size:11px;">ê¸°ì¤€ ì‹œê°„: ${dateStr} ${String(selectedHour).padStart(2, '0')}:00</span><br>
                    
                    <div class="gonogo-box" style="background: ${goBg}; border: 1px solid ${goBorder}; margin-top: 8px;">
                        <div class="gonogo-title" style="color: ${goBorder}">${goTitle}</div>
                        <div class="gonogo-item"><span>ğŸŒ™ <b>ë‹¬:</b></span> ${rMoon}</div>
                        <div class="gonogo-item"><span>â˜ï¸ <b>êµ¬ë¦„:</b></span> ${rCloud}</div>
                        <div class="gonogo-item"><span>ğŸŒŒ <b>ì½”ì–´:</b></span> ${rCore}</div>
                        <div class="gonogo-item"><span>ğŸ’¡ <b>ê´‘í•´ë°©í–¥:</b></span> ${rLP}</div>
                    </div>
                    
                    <div class="mw-window-box">
                        <div style="font-size:15px; font-weight:bold; color:#fff; text-align:center; margin-bottom:6px;">ğŸŒŒ Milky Way Window</div>
                        ${timelineBarHtml}
                        ${timelineLabelHtml}
                        
                        <div class="timeline-legend">
                            <div class="legend-item"><div class="legend-box" style="background:#06a;"></div>ì½”ì–´ ë‚®ìŒ</div>
                            <div class="legend-item"><div class="legend-box" style="background:#635;"></div>ë‹¬ ì”»ê¹€</div>
                            <div class="legend-item"><div class="legend-box" style="background:#c60;"></div>ì €ê³ ë„ë‹¬</div>
                            <div class="legend-item"><div class="legend-box" style="background:#f00;"></div>ë‹¬/ì½”ì–´ ê²¹ì¹¨</div>
                            <div class="legend-item"><div class="legend-box" style="background:#fd0;"></div><b style="color:#fd0;">ì‹¤ì „(15Â°â†‘)</b></div>
                        </div>
                        <hr style="border-top:1px dashed #555; margin:10px 0;">
                        <div style="font-size:12.5px; text-align:center;">
                            ì½”ì–´ ì§€í‰ì„  ìœ„: <span style="color:#0df">${coreWinText}</span><br>
                            <span style="font-size:14px;">âœ¨ <b>ì‹¤ì „ ê³¨ë“  ìœˆë„ìš°:</b> <span style="color:#fd0; font-weight:900;">${goldWinText}</span></span>
                        </div>
                    </div>
            `;

            if (isWeatherAvailable) popupText += `${weatherWarningHtml}`;
            popupText += `</div>`;
            marker.bindPopup(popupText).openPopup();
        }

        // --- ìµœì ê¸° ê³„ì‚°, í›„ë³´ì§€ ë¶„ì„ ë¡œì§ ìœ ì§€ (ìƒëµ ì—†ì´ ì‘ë™) ---
        function calculateBestDate() {
            var bestDate = null, minFraction = 1.0;
            for (var i = 0; i <= 30; i++) {
                var testD = new Date(); testD.setDate(testD.getDate() + i);
                var moon = SunCalc.getMoonIllumination(testD);
                if (moon.fraction < minFraction) { minFraction = moon.fraction; bestDate = testD; }
            }
            if (bestDate) {
                var bY = bestDate.getFullYear(), bM = String(bestDate.getMonth() + 1).padStart(2, '0'), bD = String(bestDate.getDate()).padStart(2, '0');
                document.getElementById('best-date-box').innerHTML = `<div style="font-size: 16px; font-weight: bold; color: #0df;">${bY}ë…„ ${bM}ì›” ${bD}ì¼</div><div style="font-size: 12px; color: #aaa; margin-top: 4px;">ì˜ˆìƒ ë‹¬ë¹›: ${Math.round(minFraction * 100)}% (ê·¸ë¯ë‹¬ ë¶€ê·¼)</div><div style="font-size: 11px; color: #777; margin-top: 4px;">í´ë¦­í•˜ì—¬ ë‚ ì§œ ì ìš©</div>`;
                document.getElementById('best-date-box').onclick = function() { document.getElementById('obs-date').value = `${bY}-${bM}-${bD}`; if(currentLat) analyzeData(currentLat, currentLng); };
            }
        }
        calculateBestDate();

        const candidateSpots = [ { name: "ì—°ì²œ ë‹¹í¬ì„± (ê²½ê¸° ë¶ë¶€)", lat: 38.013, lng: 126.949 }, { name: "íŒŒì£¼ ê°ì•…ì‚° ë¶€ê·¼ (ê²½ê¸° ë¶ë¶€)", lat: 37.942, lng: 126.960 }, { name: "ì–‘í‰ ë²—ê³ ê°œ (ê²½ê¸° ë™ë¶€)", lat: 37.534, lng: 127.387 }, { name: "ê°•ë¦‰ ì•ˆë°˜ë°ê¸° (ê°•ì› ì˜ë™)", lat: 37.615, lng: 128.823 }, { name: "í™”ì²œ ì¡°ê²½ì² ì²œë¬¸ëŒ€ (ê°•ì› ì˜ì„œ)", lat: 38.125, lng: 127.461 }, { name: "íƒœë°± ë§¤ë´‰ì‚° ë°”ëŒì˜ì–¸ë• (ê°•ì›)", lat: 37.218, lng: 128.981 }, { name: "í•©ì²œ í™©ë§¤ì‚° (ê²½ë‚¨)", lat: 35.582, lng: 127.975 }, { name: "ë¶€ì—¬ ì‚¬ë‘ë‚˜ë¬´ (ì¶©ë‚¨)", lat: 36.257, ê°•: 126.903 } ];

        document.getElementById('btn-simulate').addEventListener('click', async function() {
            var btn = this, msg = document.getElementById('simulate-msg'), targetDate = document.getElementById('obs-date').value;
            btn.disabled = true; btn.innerHTML = "ğŸ“¡ ë¶„ì„ ì¤‘..."; msg.style.display = 'block'; msg.innerText = "ì „êµ­ ì£¼ìš” ëª…ì†Œë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤.";
            let bestScore = -1, bestSpot = null, bestHour = 22; const searchHours = [0, 1, 2, 3, 4, 20, 21, 22, 23];
            try {
                for (let spot of candidateSpots) {
                    var weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${spot.lat}&longitude=${spot.lng}&hourly=cloudcover,cloudcover_low,cloudcover_mid,cloudcover_high&timezone=auto&start_date=${targetDate}&end_date=${targetDate}`;
                    var response = await fetch(weatherUrl); if (!response.ok) continue; 
                    var weatherData = await response.json(); if (!weatherData.hourly || !weatherData.hourly.cloudcover) continue;
                    
                    for (let h of searchHours) {
                        let cTotal = weatherData.hourly.cloudcover[h]; let cLow = weatherData.hourly.cloudcover_low[h]; let cMid = weatherData.hourly.cloudcover_mid[h]; let cHigh = weatherData.hourly.cloudcover_high[h];
                        let d = new Date(targetDate); d.setHours(h);
                        
                        let gcPos = getGalacticCorePosition(d, spot.lat, spot.lng);
                        let moonEval = evaluateMoonImpact(d, spot.lat, spot.lng, gcPos.azimuth);
                        let cloudEval = evaluateCloudImpact(cLow, cMid, cHigh, cTotal);
                        let lpEval = evaluateDirectionalLightPollution(spot.lat, spot.lng, gcPos.azimuth);
                        
                        let score = 100 - (cLow * 0.2) - (cMid * 0.4) - (cHigh * 1.5) - ((lpEval.bortleClass - 1) * 8);
                        
                        if (!moonEval.isSafe) score -= 30; 
                        if (moonEval.timelineColor === "#f00") score -= 60; 
                        if (!cloudEval.isSafe) score -= 50; 
                        if (!lpEval.isSafe) score -= 40; // ğŸŒŸ ê´‘í•´ ë°©í–¥ì„± í˜ë„í‹° ì¶”ê°€
                        if(gcPos.altitude <= 0) score -= 40; 
                        
                        if (score > bestScore) { bestScore = score; bestSpot = spot; bestHour = h; }
                    }
                }
                if (bestSpot && bestScore > 0) {
                    document.getElementById('obs-time').value = bestHour; document.getElementById('time-text').innerText = String(bestHour).padStart(2, '0') + ':00';
                    msg.innerText = `âœ… [${bestSpot.name}] ${bestHour}ì‹œê°€ ê°€ì¥ ìµœì ì…ë‹ˆë‹¤!`; map.setView([bestSpot.lat, bestSpot.lng], 11); analyzeData(bestSpot.lat, bestSpot.lng, bestSpot.name);
                } else { msg.innerText = "âŒ ê¸°ìƒ ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ì¡°ê±´ì´ ë§ëŠ” ê³³ì´ ì—†ìŠµë‹ˆë‹¤."; msg.style.color = "#f55"; }
            } catch (err) { msg.innerText = "ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."; } finally { btn.disabled = false; btn.innerHTML = "ğŸš€ ì„ íƒí•œ ë‚ ì§œì˜ ìµœì ì§€ ì°¾ê¸°"; }
        });

        // UI Events
        document.getElementById('map-theme').addEventListener('change', function(e) { map.removeLayer(currentBaseLayer); currentBaseLayer = e.target.value === 'dark' ? darkLayer : (e.target.value === 'satellite' ? satelliteLayer : standardLayer); currentBaseLayer.addTo(map); });
        document.getElementById('light-pollution-toggle').addEventListener('change', function(e) { e.target.checked ? lightPollutionLayer.addTo(map) : map.removeLayer(lightPollutionLayer); });
        document.getElementById('lp-opacity').addEventListener('input', function(e) { lightPollutionLayer.setOpacity(e.target.value); document.getElementById('opacity-val').innerText = Math.round(e.target.value * 100); });
        document.getElementById('btn-today').addEventListener('click', function() { document.getElementById('obs-date').value = `${yyyy}-${mm}-${dd}`; if(currentLat) analyzeData(currentLat, currentLng); });
        document.getElementById('obs-time').addEventListener('input', function(e) { document.getElementById('time-text').innerText = `${String(e.target.value).padStart(2, '0')}:00`; });
        document.getElementById('obs-time').addEventListener('change', function() { if(currentLat) analyzeData(currentLat, currentLng); });
        document.getElementById('obs-date').addEventListener('change', function() { if(currentLat) analyzeData(currentLat, currentLng); document.getElementById('simulate-msg').style.display = 'none'; });
        map.on('click', function(e) { analyzeData(e.latlng.lat, e.latlng.lng); });

    </script>
</body>
</html>